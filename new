<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Menu & Order</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lato:wght@300;400;700&family=Space+Mono&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Lato', sans-serif;
            background-color: #fdfbf7; /* Cream background */
        }
        h1, h2, h3 {
            font-family: 'Playfair Display', serif;
        }
        
        /* The "Dot Leader" effect (Item .......... Price) */
        .menu-item {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
        }
        
        .menu-item-name {
            font-weight: 700;
            color: #1f2937;
            position: relative;
            padding-right: 0.5rem;
            background-color: #fff; /* Masks the dots behind the text */
            z-index: 10;
        }

        .menu-dots {
            flex-grow: 1;
            border-bottom: 2px dotted #d1d5db;
            margin: 0 0.5rem;
            position: relative;
            top: -5px; /* Aligns dots with baseline */
        }

        .menu-item-price {
            font-weight: 700;
            color: #b45309; /* Amber/Bronze color */
            padding-left: 0.5rem;
            background-color: #fff;
            z-index: 10;
            white-space: nowrap;
        }

        /* Processing Overlay */
        .processing-overlay {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 text-gray-800 relative">

    <!-- AI Processing Overlay (Hidden by default) -->
    <div id="ai-processing" class="fixed inset-0 z-50 hidden flex-col items-center justify-center processing-overlay">
        <div class="bg-white p-8 rounded-xl shadow-2xl border border-amber-100 text-center max-w-sm mx-4">
            <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-stone-200 border-t-amber-600 mb-4"></div>
            <h3 class="text-xl font-bold text-stone-800 mb-2">Chef is thinking...</h3>
            <p class="text-stone-500 text-sm">Parsing your order and checking the menu.</p>
        </div>
    </div>

    <div class="max-w-3xl mx-auto bg-white shadow-xl rounded-lg overflow-hidden border border-stone-200">
        
        <!-- Header Section -->
        <div class="bg-stone-900 text-center py-10 px-4 relative">
            <!-- Decorative border inside header -->
            <div class="absolute inset-2 border border-stone-700 pointer-events-none"></div>
            
            <h1 class="text-4xl md:text-6xl text-amber-50 font-bold mb-2 tracking-wider">THE MENU</h1>
            <p class="text-stone-400 italic text-lg">Fresh Ingredients & Handcrafted Dishes</p>
        </div>

        <!-- Menu Content -->
        <div class="p-6 md:p-10">
            
            <!-- Loading State -->
            <div id="loading" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-stone-200 border-t-amber-600"></div>
                <p class="mt-4 text-stone-500">Loading fresh content...</p>
            </div>

            <!-- Error State (Hidden by default) -->
            <div id="error" class="hidden text-center py-10 text-red-600 bg-red-50 rounded-lg">
                <p>Unable to load the menu. Please check your connection.</p>
            </div>

            <!-- Menu Grid -->
            <div id="menu-container" class="space-y-6 hidden">
                <!-- Items will be injected here via JS -->
            </div>
            
        </div>

        <!-- Ordering Section -->
        <div class="mt-2 bg-stone-50 p-8 border-t border-stone-200">
            <label for="order-input" class="block font-serif text-2xl font-bold text-stone-800 mb-4">
                Ready to order?
            </label>
            <div class="relative">
                <input 
                    type="text" 
                    id="order-input" 
                    placeholder="e.g. I'll have the burger and a glass of white wine..." 
                    class="w-full bg-white text-stone-700 text-lg border border-stone-300 rounded-md px-4 py-4 pr-32
                           placeholder-stone-400 shadow-sm focus:outline-none focus:ring-2 focus:ring-amber-600 
                           focus:border-transparent transition-all duration-200 ease-in-out"
                >
                <div class="absolute right-2 top-2 bottom-2 flex space-x-2">
                    <button id="mic-btn" onclick="startDictation()" class="text-stone-400 hover:text-amber-600 hover:bg-stone-100 px-3 rounded transition-colors" title="Speak order">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z" />
                        </svg>
                    </button>
                    <button onclick="submitOrder()" class="bg-amber-600 hover:bg-amber-700 text-white px-4 rounded transition-colors" title="Submit order">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                        </svg>
                    </button>
                </div>
            </div>
            <p class="text-xs text-stone-400 mt-2 italic">Type nicely formatted requests or quick notes. We'll figure it out.</p>
        </div>

        <!-- Footer -->
        <div class="bg-stone-100 p-4 text-center border-t border-stone-200">
            <p class="text-sm text-stone-500">&copy; 2025 Restaurant Name. Prices subject to change.</p>
        </div>
    </div>

<script>
    // 1. CONFIGURATION
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQT_Q-Wtfqb-IJCda_J9Y2SpVXce-Pctta39TTHT750sfIOR_r8qhajidVYrejdsoYgeLZSTC6F7kOK/pub?gid=0&single=true&output=tsv';
    const apiKey = "AIzaSyDcnrJgFfSUIWVhLwaAZGzpQb9UnJpPhwk"; // Environment provides this

    // Global variable to hold the parsed menu for the AI
    window.menuData = [];

    // 2. INITIALIZATION & RENDER
    async function fetchSheetData(url) {
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            const tsvText = await response.text();
            parseAndRender(tsvText);
        } catch (error) {
            console.error("An error occurred:", error);
            document.getElementById("loading").classList.add("hidden");
            document.getElementById("error").classList.remove("hidden");
            document.getElementById("error").innerText = "Error loading menu data: " + error.message;
        }
    }

    function parseAndRender(tsv) {
        const container = document.getElementById("menu-container");
        const loading = document.getElementById("loading");
        const rows = tsv.trim().split('\n');
        
        let htmlContent = '';
        window.menuData = []; // Reset global data

        rows.forEach((row) => {
            const cleanRow = row.replace(/\r/g, '');
            if (!cleanRow) return;

            const columns = cleanRow.split('\t');
            if (columns.length > 0) {
                const itemName = columns[0].trim();
                const itemPrice = columns.length > 1 ? columns[1].trim() : '';

                // Store in global array for AI context (Skip headers if identified, but simple check here)
                if(itemName && itemPrice) {
                   window.menuData.push({ item: itemName, price: itemPrice });
                }

                htmlContent += `
                    <div class="menu-item group">
                        <span class="menu-item-name text-lg md:text-xl font-serif tracking-wide group-hover:text-amber-700 transition-colors">
                            ${itemName}
                        </span>
                        <span class="menu-dots"></span>
                        <span class="menu-item-price text-lg font-mono">
                            ${itemPrice}
                        </span>
                    </div>
                `;
            }
        });

        container.innerHTML = htmlContent;
        loading.classList.add('hidden');
        container.classList.remove('hidden');
    }

    // 3. EVENT LISTENERS
    document.getElementById('order-input').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            submitOrder();
        }
    });

    // Voice Input Logic
    function startDictation() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();

            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = "en-US";

            const micBtn = document.getElementById('mic-btn');
            
            // Visual feedback for listening
            micBtn.classList.remove('text-stone-400');
            micBtn.classList.add('text-red-500', 'animate-pulse');

            recognition.start();

            recognition.onresult = function(e) {
                const transcript = e.results[0][0].transcript;
                // Append to existing text if any, or replace
                const currentVal = document.getElementById('order-input').value;
                document.getElementById('order-input').value = currentVal ? currentVal + " " + transcript : transcript;
                recognition.stop();
            };

            recognition.onerror = function(e) {
                console.error("Speech error:", e);
                recognition.stop();
            };
            
            recognition.onend = function() {
                 micBtn.classList.remove('text-red-500', 'animate-pulse');
                 micBtn.classList.add('text-stone-400');
            };
        } else {
            alert("Speech recognition is not supported in this browser. Try Chrome or Safari.");
        }
    }

    // 4. AI ORDER LOGIC
    async function submitOrder() {
        const input = document.getElementById('order-input');
        const userOrder = input.value.trim();
        
        if (!userOrder) return;
        if (window.menuData.length === 0) {
            alert("Menu data not loaded yet.");
            return;
        }

        // Show processing UI
        const overlay = document.getElementById('ai-processing');
        overlay.classList.remove('hidden');
        overlay.classList.add('flex');

        try {
            const receiptData = await parseOrderWithGemini(userOrder, window.menuData);
            generateReceiptWindow(receiptData);
            input.value = ''; // Clear input on success
        } catch (error) {
            console.error("AI Error:", error);
            alert("Sorry, we couldn't process that order. Please try again.");
        } finally {
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
        }
    }

    async function parseOrderWithGemini(userOrder, menuContext) {
        // Construct the prompt
        const systemPrompt = `
        You are an intelligent POS (Point of Sale) system for a restaurant.
        
        Your goal is to take a natural language order from a customer and match it against the provided MENU DATA.
        
        MENU DATA:
        ${JSON.stringify(menuContext)}

        INSTRUCTIONS:
        1. Analyze the USER ORDER.
        2. Match items vaguely (e.g., "coke" might match "Coca Cola", "steak" matches "Ribeye").
        3. If a user orders something not on the menu, mark it as "Special Request" with price 0.00.
        4. Calculate subtotals based on the menu prices. Strip '$' symbols for calculation.
        5. Return ONLY valid JSON. No markdown formatting.
        
        JSON STRUCTURE:
        {
          "items": [
            { "name": "Matched Menu Name", "qty": number, "unit_price": "string with $", "subtotal": "string with $" }
          ],
          "grand_total": "string with $"
        }
        `;

        const userPrompt = `USER ORDER: "${userOrder}"`;

        // Call Gemini
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: { responseMimeType: "application/json" }
            })
        });

        if (!response.ok) throw new Error("Gemini API failed");
        
        const data = await response.json();
        const textResult = data.candidates[0].content.parts[0].text;
        
        return JSON.parse(textResult);
    }

    // 5. RECEIPT UI
    function generateReceiptWindow(data) {
        const date = new Date().toLocaleString();
        
        let itemsHtml = '';
        data.items.forEach(item => {
            itemsHtml += `
                <div class="item-row">
                    <div class="qty-name">
                        <span class="qty">${item.qty}</span>
                        <span class="name">${item.name}</span>
                    </div>
                    <span class="price">${item.subtotal}</span>
                </div>
            `;
        });

        const receiptHtml = `
        <html>
        <head>
            <title>Order Receipt</title>
            <style>
                body {
                    font-family: 'Courier New', Courier, monospace;
                    background-color: #eee;
                    padding: 20px;
                    display: flex;
                    justify-content: center;
                }
                .receipt {
                    background: #fff;
                    width: 300px;
                    padding: 20px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                }
                .header {
                    text-align: center;
                    border-bottom: 2px dashed #000;
                    padding-bottom: 10px;
                    margin-bottom: 15px;
                }
                .title { font-weight: bold; font-size: 1.2em; }
                .meta { font-size: 0.8em; color: #555; margin-top: 5px; }
                
                .item-row {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 8px;
                    font-size: 0.9em;
                }
                .qty { font-weight: bold; margin-right: 10px; }
                
                .total-section {
                    border-top: 2px dashed #000;
                    margin-top: 15px;
                    padding-top: 10px;
                    display: flex;
                    justify-content: space-between;
                    font-weight: bold;
                    font-size: 1.1em;
                }
                .footer {
                    margin-top: 20px;
                    text-align: center;
                    font-size: 0.8em;
                }
            </style>
        </head>
        <body>
            <div class="receipt">
                <div class="header">
                    <div class="title">THE RESTAURANT</div>
                    <div class="meta">Order #${Math.floor(Math.random() * 10000)}</div>
                    <div class="meta">${date}</div>
                </div>
                
                <div class="items">
                    ${itemsHtml}
                </div>

                <div class="total-section">
                    <span>TOTAL</span>
                    <span>${data.grand_total}</span>
                </div>

                <div class="footer">
                    Thank you for dining with us!<br>
                    Please pay at the counter.
                </div>
            </div>
        </body>
        </html>
        `;

        const win = window.open("", "Receipt", "width=400,height=600,scrollbars=yes");
        win.document.write(receiptHtml);
        win.document.close(); // Ensure content loads
    }

    // Start App
    fetchSheetData(sheetUrl);

</script>
</body>
</html>
